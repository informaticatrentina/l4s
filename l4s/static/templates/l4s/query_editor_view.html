<!--
This file is part of Lod4stat.

Copyright (c) 2014 Provincia autonoma di Trento


This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as
published by the Free Software Foundation, either version 3 of the
License, or (at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program. If not, see <http://www.gnu.org/licenses/>.
-->

{% extends "explorer/base.html" %}
{% load i18n %}
{% load jsonify %}
{% load dictionary_extras %}

{% block l4s_container %}
<h3>{{ title }}</h3>
<div style="overflow: auto; max-heigth: 100%;" id="overflow_wrapper">
    <center>
        <table border="1" class="dataframe table table-striped">
            {% for agg in agg_col %}
            <thead>
            <tr>
                <th colspan="2">{{ agg_col|lookup:agg|lookup:"title" }}</th>
            </tr>
            </thead>
            {% endfor %}
            {% for sel in sel_tab %}
            <thead>
            <tr>
                <th>{{ sel }}</th>
                <th>
                    {% if sel_tab|lookup:sel|length > 1 %}
                    {{ sel_tab|lookup:sel|length }} {% trans "values" %}:
                    {% endif %}
                    {% for s in sel_tab|lookup:sel|slice:":9" %}
                    {{ s }}{% if forloop.counter0 == 8 %}<text id="suspension_points">...</text>
                    <a id="morebtn" class="navbar-right" data-toggle="collapse" data-target="#more" href="javascript:void(0)">{% trans "See more" %}</a>
                    <div id="more" class="collapse">{% for s in sel_tab|lookup:sel|slice:"9:" %}{{s}}, {% endfor %}</div>
                    {% else %}{% if not forloop.last %},{% endif %}{% endif %}
                    {% endfor %}
                </th>
            </tr>
            </thead>
            {% endfor %}
        </table>
    </center>
{% if error %}
<div class="alert alert-danger">
    {{ error|escape }}
</div>
{% else %}

<button class="btn btn-default" onclick="OpenCustomizePopup();">{% trans "Customize" %}</button>
                                <div class="btn-group">
                                <button type="button"
                                        class="btn btn-default dropdown-toggle"
                                        data-toggle="dropdown">
                                    {% trans "Export" %}
                                    <span class="caret"></span>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="btn btn-default download_csv_button" href="#">CSV</a></li>
                                    <li><a class="btn btn-default download_xls_button" href="#">Excel 1997</a></li>
                                    <li><a class="btn btn-default download_xlsx_button" href="#">Excel 2007</a></li>
                                    <li><a class="btn btn-default download_rdf_button" href="#">Rdf</a></li>
                                    <li><a class="btn btn-default download_turtle_button" href="#">Turtle</a></li>
                                    <li><a class="btn btn-default download_sdmx_button" href="#">Sdmx</a></li>
                                    <li><a class="btn btn-default download_json_stat_button" href="#">JSON-stat</a></li>
                                </ul>
                            </div>
{% if request.user.is_authenticated %}
<button class="btn btn-default" onclick="OpenSavePopup();">{% trans "Save" %}</button>
{% endif %}
{% if request.user.is_authenticated %}
<input type="button" class="btn btn-default" value="{% trans "Manual request" %}" onclick="location.href='/manual_request'">
{% endif %}
{% if dataframe %}
<div style="overflow: auto; max-heigth: 100%;" id="overflow_wrapper">
    <center>
    {{ dataframe|safe }}
    </center>
</div>
{% endif %}
<form id="form" method="post">
    {% csrf_token %}
</form>
<script type="text/javascript" src="/static/js/jquery.cookie.js"></script>
<script type="text/javascript" src="/static/js/ajax_csfrtoken.js"></script>
<script type="text/javascript" src="/static/js/download.js"></script>
<script>
initToken();
function OpenPopupCenter(pageURL, title, w, h) {
    var left = (screen.width - w) / 2;
    // for 25% - divide by 4  |  for 33% - divide by 3
    var top = (screen.height - h) / 4;
    var opt = 'toolbar=no, location=no, directories=no, status=no, ' +
              'menubar=no, scrollbars=no, resizable=no, copyhistory=no, ' +
              ' width=' + w + ', height=' + h + ', top=' + top + ', left=' +
              left
    var targetWin = window.open(pageURL, title, opt);
    targetWin.focus();
    return targetWin;
}
function OpenCustomizePopup() {
    url = '/query_editor_customize?table={{ table_name }}'
    url += '&rows={{ rows }}&columns={{ columns }}';
    agg = '{{ sel_aggregate }}';
    if (agg != "") {
         url = url + '&aggregate=' + agg
    }
    debug = '{{ debug }}';
    if (debug=='True') {
         url = url + '&debug=true'
    }
    title = '{% trans "Customize" %}';
    w = 900;
    h = 600;
    OpenPopupCenter(url, title, w, h);
}
function OpenSavePopup() {
    title = '{% trans "Save" %}';
    w = 800;
    h = 340;
    filters = "{{ filters }}";
    url = '/query_editor_save/';
    data = { 'title': '{{ title|escapejs }}',
             'description':'{{ description|escapejs }}',
             'sql':'{{ sql|escapejs }}',
             'table': '{{ table_name|escapejs }}',
             'columns': '{{ columns|escapejs }}',
             'rows': '{{ rows }}',
             'aggregations': '{{ sel_aggregate|escapejs }}',
             'filters': '{{ filters|jsonify|escapejs }}',
             'agg_filters': '{{ agg_filters|jsonify|escapejs }}'
              };
    $.ajax({
		url: url,
        type: "POST",
        data: data,
        success: function(response) {
        x = OpenPopupCenter('', title, w, h);
        x.document.write(response);
	    },
        error: function(xhr, status) {
			alert(status);
			}
    });
}
$(document).ready(function() {
    $("#morebtn").click(function() {
        $(this).html(($(this).html() == "{% trans "See more" %}")? "{% trans "See less" %}" : "{% trans "See more" %}");
        var el = document.getElementById("suspension_points");
        if (el.innerHTML == "...") {
            el.innerHTML = ",";
        }
        else {
            el.innerHTML = "...";
        }
    });
});
$("#apply_button").click(function() {
    var progress$ = $("#progress");
    progress$.show();
    action = get_params(this, "");
    $(this).closest("form").attr('action', action);
});
$("#refresh_button").click(function() {
    var progress$ = $("#progress");
    progress$.show();
    action = get_params(this, "");
    $(this).closest("form").attr('action', action);
});
$("#refresh_button_save").click(function() {
    var progress$ = $("#progress");
    progress$.show();
    action = "?save=true"
    action = get_params(this, action);
    $(this).closest("form").attr('action', action);
});
$(".download_csv_button").click(function(e) {
    e.preventDefault();
    store = "{{ store }}";
    title = "{{ title.strip }}";
    params = "store=" + store + "&title=" +  title
    download('/download_csv',
             params,
             'POST',
             "{% csrf_token %}");
});
$(".download_xls_button").click(function(e) {
    e.preventDefault();
    store = "{{ store }}";
    title = "{{ title.strip }}";
    description = "{{ description.strip|escapejs }}";
    params = "store=" + store + "&title=" +  title
    if (description != "" ) {
        params = params + "&description=" + description;
    }
    download('/download_xls',
             params,
             'POST', "{% csrf_token %}");
});
$(".download_xlsx_button").click(function(e) {
    e.preventDefault();
    store = "{{ store }}";
    title = "{{ title.strip }}";
    description = "{{ description.strip|escapejs }}";
    params = "store=" + store + "&title=" +  title
    if (description != "" ) {
        params = params + "&description=" + description;
    }
    download('/download_xlsx',
             params,
             'POST', "{% csrf_token %}");
});
$(".download_sdmx_button").click(function(e) {
    e.preventDefault();
    store = "{{ store }}";
    title = "{{ title.strip }}";
    sql = "{{ sql|escapejs }}"
    params = "store=" + store + "&title=" +  title + "&sql=" + sql
    download('/download_sdmx',
             params,
             'POST', "{% csrf_token %}");
});
$(".download_json_stat_button").click(function(e) {
    e.preventDefault();
    store = "{{ store }}";
    title = "{{ title.strip }}";
    params = "store=" + store + "&title=" +  title
    download('/download_json_stat',
             params,
             'POST', "{% csrf_token %}");
});
$(".download_rdf_button").click(function(e) {
   e.preventDefault();
   store = "{{ store }}";
   title = "{{ title.strip }}";
   sql = "{{ sql.strip|escapejs }}"
   description = "{{ description|escapejs }}"
   params = "store=" + store + "&title=" +  title + "&sql=" + sql +
           "&description=" + description
   download('/download_rdf',
            params,
            'POST', "{% csrf_token %}");
});
$(".download_turtle_button").click(function(e) {
   e.preventDefault();
   store = "{{ store }}";
   title = "{{ title.strip }}";
   sql = "{{ sql.strip|escapejs }}"
   description = "{{ description.strip|escapejs }}"
   params = "store=" + store + "&title=" +  title + "&sql=" + sql +
            "&description=" + description
   download('/download_turtle',
            params,
            'POST',
            "{% csrf_token %}");
});
</script>
{% endif %}
{% endblock %}

