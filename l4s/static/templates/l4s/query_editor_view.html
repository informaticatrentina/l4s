<!--
This file is part of Lod4stat.

Copyright (c) 2014 Provincia autonoma di Trento


This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as
published by the Free Software Foundation, either version 3 of the
License, or (at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program. If not, see <http://www.gnu.org/licenses/>.
-->

{% extends "explorer/base.html" %}
{% load i18n %}
{% load jsonify %}
{% load dictionary_extras %}


{% block l4s_container %}
<!-- Modal -->
<div class="modal fade" id="popup" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-body" id="popup-body">
      </div>
    </div>
  </div>
</div>

<div class="col-sm-12">
    <ul class="breadcrumb">
        <li>
            <li><a href="/query_editor/">{% trans "Query editor" %}</a></li>
            <li><a href="/query_editor/?topic={{ topic_id }}">{{ topic }}</a></li>
        </li>
    </ul>
</div>
<h3>{{ title }}</h3>
<div style="overflow: auto; max-heigth: 100%;" id="overflow_wrapper">
    <center>
        <table border="1" class="dataframe table table-striped">
            {% for agg in agg_col %}
            <thead>
            <tr>
                <th colspan="2">{{ agg_col|lookup:agg|lookup:"title" }}</th>
            </tr>
            </thead>
            {% endfor %}
            {% for sel in sel_tab %}
            <thead>
            <tr>
                <th>{{ sel }}</th>
                <th>
                    {% if sel_tab|lookup:sel|length > 1 %}
                    {{ sel_tab|lookup:sel|length }} {% trans "values" %}:
                    {% endif %}
                    {% for s in sel_tab|lookup:sel|slice:":9" %}
                    {{ s }}{% if forloop.counter0 == 8 %}<text id="suspension_points">...</text>
                    <a id="morebtn" class="navbar-right" data-toggle="collapse" data-target="#more" href="javascript:void(0)">{% trans "See more" %}</a>
                    <div id="more" class="collapse">{% for s in sel_tab|lookup:sel|slice:"9:" %}{{s}}, {% endfor %}</div>
                    {% else %}{% if not forloop.last %},{% endif %}{% endif %}
                    {% endfor %}
                </th>
            </tr>
            </thead>
            {% endfor %}
        </table>
    </center>
{% if error %}
<div class="alert alert-danger">
    {{ error|escape }}
</div>
{% else %}
 <div class="btn-group">
<button class="btn btn-default" onclick="OpenCustomizePopup();">{% trans "Customize" %}</button>

                                <div class="btn-group">
                                <button type="button"
                                        class="btn btn-default dropdown-toggle"
                                        data-toggle="dropdown">
                                    {% trans "Export" %}
                                    <span class="caret"></span>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="btn btn-default download_csv_button" href="#">CSV</a></li>
                                    <li><a class="btn btn-default download_xls_button" href="#">Excel 1997-2003</a></li>
                                    <li><a class="btn btn-default download_xlsx_button" href="#">Excel 2007</a></li>
                                    <li><a class="btn btn-default download_rdf_button" href="#">RDF Data Cube</a></li>
                                    <li><a class="btn btn-default download_turtle_button" href="#">Turtle</a></li>
                                    <li><a class="btn btn-default download_sdmx_button" href="#">Sdmx</a></li>
                                    <li><a class="btn btn-default download_json_stat_button" href="#">JSON-stat</a></li>
                                </ul>
                            </div>
{% if request.user.is_authenticated %}
<button class="btn btn-default" onclick="OpenSavePopup();">{% trans "Save" %}</button>
<button class="btn btn-default" onclick="OpenManualrequestPopup();">{% trans "Manual request" %}</button>
{% else %}
<button class="btn btn-default" onclick='alert("{% trans "Log in to use this feature" %}");'>{% trans "Save" %}</button>
<button class="btn btn-default" value="{% trans "Manual request" %}" onclick='alert("{% trans "Log in to use this feature" %}");'>{% trans "Manual request" %}</button>
{% endif %}
</div>
{% if dataframe %}
<div style="overflow: auto; max-heigth: 100%;" id="overflow_wrapper">
    <center>
    {{ dataframe|safe }}
    </center>
</div>
{% endif %}
{% endif %}
<script type="text/javascript" src="/static/js/jquery.cookie.js"></script>
<script type="text/javascript" src="/static/js/ajax_csfrtoken.js"></script>
<script type="text/javascript" src="/static/js/download.js"></script>
<script>
initToken();
function OpenCustomizePopup() {
    debug_value = "false"
    debug = '{{ debug }}';
    if (debug=='True') {
       debug_value = "true"
    }
    include_code_value = "false"
    include_code = '{{ include_code }}';
    if (include_code=='True') {
       include_code_value = "true"
    }
    url = '/query_editor_customize/';
    data = { 'table': '{{ table_name|escapejs }}',
             'columns': '{{ columns|escapejs }}',
             'rows': '{{ rows|escapejs }}',
             'selected_obs_values': '{{ selected_obs_values|escapejs }}',
             'aggregations': '{{ aggregations|jsonify|escapejs }}',
             'filters': '{{ filters|jsonify|escapejs }}',
             'agg_filters': '{{ agg_filters|jsonify|escapejs }}',
             'aggregate': '{{ sel_aggregate|escapejs }}',
             'column_description': '{{ column_description|jsonify|escapejs }}',
             'values': '{{ values |jsonify|escapejs }}',
             'agg_values': '{{ agg_values |jsonify|escapejs }}',
             'hidden_fields': '{{ hidden_fields |jsonify|escapejs }}',
             'ref_periods': '{{ ref_periods|escapejs }}',
             'include_code': include_code_value,
             'debug': debug_value,
              };
    $.ajax({
		url: url,
        type: "POST",
        data: data,
        success: function(response) {
            $('#popup-body').html(response);
            $('#popup').modal('show');
	    },
        error: function(xhr, status) {
            alert(xhr.responseText);
			alert(status);
	    }
    });

}
function OpenManualrequestPopup() {
    url = '/manual_request/';
    data = { 'title': '{{ title|escapejs }}',
             'url':'{{ url|escapejs }}'
    };
    $.ajax({
		url: url,
        type: "POST",
        data: data,
        success: function(response) {
        $('#popup-body').html(response);
        $('#popup').modal('show');
	    },
        error: function(xhr, status) {
			alert(status);
			}
    });
}
function OpenSavePopup() {
    filters = "{{ filters }}";
    include_code_value = "false"
    include_code = '{{ include_code }}';
    if (include_code=='True') {
       include_code_value = "true"
    }

    url = '/query_editor_save/';
    data = { 'title': '{{ title|escapejs }}',
             'description':'{{ description|escapejs }}',
             'sql':'{{ sql|escapejs }}',
             'table': '{{ table_name|escapejs }}',
             'columns': '{{ columns|escapejs }}',
             'rows': '{{ rows }}',
             'obs_values': '{{ selected_obs_values|escapejs }}',
             'aggregations': '{{ sel_aggregate|escapejs }}',
             'filters': '{{ filters|jsonify|escapejs }}',
             'agg_filters': '{{ agg_filters|jsonify|escapejs }}',
             'include_code': include_code_value
              };
    $.ajax({
		url: url,
        type: "POST",
        data: data,
        success: function(response) {
        $('#popup-body').html(response);
        $('#popup').modal('show');
	    },
        error: function(xhr, status) {
			alert(status);
			}
    });
}
$("#morebtn").click(function() {
    $(this).html(($(this).html() == "{% trans "See more" %}")? "{% trans "See less" %}" : "{% trans "See more" %}");
    var el = document.getElementById("suspension_points");
    if (el.innerHTML == "...") {
        el.innerHTML = ",";
    }
    else {
        el.innerHTML = "...";
    }
});
$("#apply_button").click(function() {
    var progress$ = $("#progress");
    progress$.show();
    action = get_params(this, "");
    $(this).closest("form").attr('action', action);
});
$("#refresh_button").click(function() {
    var progress$ = $("#progress");
    progress$.show();
    action = get_params(this, "");
    $(this).closest("form").attr('action', action);
});
$("#refresh_button_save").click(function() {
    var progress$ = $("#progress");
    progress$.show();
    action = "?save=true"
    action = get_params(this, action);
    $(this).closest("form").attr('action', action);
});
$(".download_csv_button").click(function(e) {
    e.preventDefault();
    store = "{{ store }}";
    title = "{{ title.strip }}";
    params = "store=" + store + "&title=" +  title
    download('/download_csv',
             params,
             'POST',
             "{% csrf_token %}");
});
$(".download_xls_button").click(function(e) {
    e.preventDefault();
    store = "{{ store }}";
    title = "{{ title.strip }}";
    description = "{{ description.strip|escapejs }}";
    params = "store=" + store + "&title=" +  title
    if (description != "" ) {
        params = params + "&description=" + description;
    }
    download('/download_xls',
             params,
             'POST', "{% csrf_token %}");
});
$(".download_xlsx_button").click(function(e) {
    e.preventDefault();
    store = "{{ store }}";
    title = "{{ title.strip }}";
    description = "{{ description.strip|escapejs }}";
    params = "store=" + store + "&title=" +  title
    if (description != "" ) {
        params = params + "&description=" + description;
    }
    download('/download_xlsx',
             params,
             'POST', "{% csrf_token %}");
});
$(".download_sdmx_button").click(function(e) {
    e.preventDefault();
    store = "{{ store }}";
    title = "{{ title.strip }}";
    sql = "{{ sql|escapejs }}"
    params = "store=" + store + "&title=" +  title + "&sql=" + sql
    download('/download_sdmx',
             params,
             'POST', "{% csrf_token %}");
});
$(".download_json_stat_button").click(function(e) {
    e.preventDefault();
    store = "{{ store }}";
    title = "{{ title.strip }}";
    params = "store=" + store + "&title=" +  title
    download('/download_json_stat',
             params,
             'POST', "{% csrf_token %}");
});
$(".download_rdf_button").click(function(e) {
   e.preventDefault();
   store = "{{ store }}";
   title = "{{ title.strip }}";
   sql = "{{ sql.strip|escapejs }}"
   description = "{{ description|escapejs }}"
   params = "store=" + store + "&title=" +  title + "&sql=" + sql +
           "&description=" + description
   download('/download_rdf',
            params,
            'POST', "{% csrf_token %}");
});
$(".download_turtle_button").click(function(e) {
   e.preventDefault();
   store = "{{ store }}";
   title = "{{ title.strip }}";
   sql = "{{ sql.strip|escapejs }}"
   description = "{{ description.strip|escapejs }}"
   params = "store=" + store + "&title=" +  title + "&sql=" + sql +
            "&description=" + description
   download('/download_turtle',
            params,
            'POST',
            "{% csrf_token %}");
});
</script>
{% endblock %}

