<!--
This file is part of Lod4stat.

Copyright (c) 2014 Provincia autonoma di Trento


This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as
published by the Free Software Foundation, either version 3 of the
License, or (at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program. If not, see <http://www.gnu.org/licenses/>.
-->

{% extends "explorer/base.html" %}
{% load i18n %}
{% load jsonify %}
{% load dictionary_extras %}


{% block l4s_container %}
<!-- Modal -->
<div class="modal fade"
     id="popup" tabindex="-1"
     role="dialog"
     aria-labelledby="myModalLabel"
     aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-body" id="popup-body">
      </div>
    </div>
  </div>
</div>

<div class="col-sm-12">
    <ul class="breadcrumb">
        <li>
            <li>
                <a href="/query_editor/">{% trans "Query editor" %}</a>
            </li>
            <li>
                <a href="/query_editor/?topic={{ topic_id }}">{{ topic }}</a>
            </li>
        </li>
    </ul>
</div>
<h3 data-intro="{% trans "Query title" %}"
    data-position="data-position="right"">{{ title }}</h3>
<div style="overflow: auto; max-heigth: 100%;" id="overflow_wrapper">
        <table data-intro="{% trans "Query summary" %}"
               data-position="right"
               style="width:auto"
               class="table">
            {% for agg in agg_col %}
            <tr>
                <th colspan="2">{{ agg_col|lookup:agg|lookup:"title" }}</th>
            </tr>
            {% endfor %}
            {% for sel in sel_tab %}
            <tr>
                <td>{{ sel }}</td>
                <td><i>
                    {% if sel_tab|lookup:sel|length > 1 %}
                    {{ sel_tab|lookup:sel|length }} {% trans "values" %}:
                    {% endif %}
                    {% for s in sel_tab|lookup:sel|slice:":9" %}
                    {{ s }}{% if forloop.counter0 == 8 %}<text id="suspension_points">...</text>
                    <a id="morebtn"
                       class="navbar-right"
                       data-toggle="collapse"
                       data-target="#more"
                       href="javascript:void(0)">{% trans "See more" %}</a>
                    <div id="more" class="collapse">{% for s in sel_tab|lookup:sel|slice:"9:" %}{{s}}, {% endfor %}</div>
                    {% else %}{% if not forloop.last %},{% endif %}{% endif %}
                    {% endfor %}</i>
                </td>
            </tr>
            {% endfor %}
        </table>
{% if error %}
<div class="alert alert-danger">
    {{ error|escape }}
</div>
{% else %}
<h5>{% trans "This is a preview" %}: {% trans "in order to get the full result set click on 'Export' and choose a format." %}</h5>
{% if show_legend == True %}
<h6>{{ legend }} (<a target="_blank" href="http://en.istat.it/dlgs322.pdf">{{dl_art}}</a>)</h6>
{% endif %}
 <div class="btn-group">
     <button title="{% trans "Allow to choose fields, perform aggregations and filter result set" %}"
             data-intro="{% trans "Allow to choose fields, perform aggregations and filter result set" %}"
             data-position="top"
             class="btn btn-default"
             onclick="OpenCustomizePopup();">{% trans "Customize" %}</button>
     <div class="btn-group">
         <button title="{% trans "Export query result set in various formats" %}"
                 data-intro="{% trans "Export query result set in various formats" %}"
                 data-position="bottom"
                 type="button"
                 class="btn btn-default dropdown-toggle"
                 data-toggle="dropdown">
             {% trans "Export" %}
             <span class="caret"></span>
         </button>
         <ul class="dropdown-menu">
             <li><a class="btn btn-default download_csv_button"
                    href="#">
                     CSV
                 </a>
             </li>
             <li>
                 <a class="btn btn-default download_xls_button"
                    href="#">
                     Excel 1997-2003
                 </a>
             </li>
             <li>
                 <a class="btn btn-default download_xlsx_button"
                    href="#">
                     Excel 2007
                 </a>
             </li>
             <li><a class="btn btn-default download_rdf_button"
                    href="#">
                     RDF Data Cube
                 </a>
             </li>
             <li><a class="btn btn-default download_turtle_button"
                    href="#">
                     Turtle
                 </a>
             </li>
             <li><a class="btn btn-default download_sdmx_button"
                    href="#">
                     Sdmx
                 </a>
             </li>
             <li><a class="btn btn-default download_json_stat_button"
                    href="#">
                     JSON-stat
                 </a>
             </li>
         </ul>
     </div>
{% if request.user.is_authenticated %}
     <button title="{% trans "Save query in your personal queries" %}"
             data-intro="{% trans "Save query in your personal queries" %}"
             data-position="top"
             class="btn btn-default"
             onclick="OpenSavePopup();">
     {% trans "Save" %}
     </button>
     <button title="{% trans "Fill out a form to submit manual request for statistics" %}"
             data-intro="{% trans "Fill out a form to submit manual request for statistics" %}"
             data-position="bottom"
             class="btn btn-default"
             onclick="OpenManualrequestPopup();">
     {% trans "Manual request" %}
     </button>
{% else %}
     <button title="{% trans "Save query in your personal queries" %}"
             data-intro="{% trans "Save query in your personal queries" %}"
             data-position="top"
             class="btn btn-default"
             onclick='bootbox.alert("{% trans "Log in or register now to use this feature" %}");'>
     {% trans "Save" %}
     </button>
     <button title="{% trans "Fill out a form to submit manual request for statistics" %}"
             data-intro="{% trans "Fill out a form to submit manual request for statistics" %}"
             data-position="bottom"
             class="btn btn-default"
             onclick='bootbox.alert("{% trans "Log in or register now to use this feature" %}");'>
     {% trans "Manual request" %}
     </button>
{% endif %}
</div>
{% if dataframe %}
<div data-intro="{% trans "Result set preview" %}"
     data-position="data-position="right""
     style="overflow: auto; max-heigth: 100%;"
     id="dataframe">
    <center>
    {{ dataframe|safe }}
    </center>
</div>
{% endif %}
{% endif %}
<script type="text/javascript" src="/static/js/jquery.cookie.js"></script>
<script type="text/javascript" src="/static/js/ajax_csfrtoken.js"></script>
<script type="text/javascript" src="/static/js/download.js"></script>
<script src="/static/js/jquery-ui.js"></script>
<script type="text/javascript" src="/static/js/query_editor_customize.js"></script>
<script>
initToken();
$('#progress').hide();
function OpenCustomizePopup() {
    debug_value = "false"
    debug = '{{ debug }}';
    if (debug=='True') {
       debug_value = "true"
    }
    include_code_value = "false"
    include_code = '{{ include_code }}';
    if (include_code=='True') {
       include_code_value = "true"
    }
    range_value = "false"
    range = '{{ range }}';
    if (range=='True') {
       range_value = "true"
    }
    url = '/query_editor_customize/';
    data = { 'table': '{{ table_name|escapejs }}',
             'columns': '{{ columns|escapejs }}',
             'rows': '{{ rows|escapejs }}',
             'selected_obs_values': '{{ selected_obs_values|escapejs }}',
             'aggregations': '{{ aggregations|jsonify|escapejs }}',
             'filters': '{{ filters|jsonify|escapejs }}',
             'agg_filters': '{{ agg_filters|jsonify|escapejs }}',
             'aggregate': '{{ sel_aggregate|escapejs }}',
             'column_description': '{{ column_description|jsonify|escapejs }}',
             'values': '{{ values |jsonify|escapejs }}',
             'agg_values': '{{ agg_values |jsonify|escapejs }}',
             'hidden_fields': '{{ hidden_fields |jsonify|escapejs }}',
             'ref_periods': '{{ ref_periods|escapejs }}',
             'include_code': include_code_value,
             'range': range_value,
             'debug': debug_value,
             'not_sel_aggregations': '{{ not_sel_aggregations|escapejs }}',
             'not_agg_selection_value': '{{ not_agg_selection_value|jsonify|escapejs }}'
              };
    $.ajax({
		url: url,
        type: "POST",
        data: data,
        success: function(response) {
            $('#popup-body').html(response);
            $('#popup').modal('show');
	    },
        error: function(xhr, status) {
            bootbox.alert(xhr.responseText);
	    }
    });
}
function OpenManualrequestPopup() {
    title = '{% trans "Manual request" %}';
    url = '/manual_request/';
    data = { 'title': '{{ title|escapejs }}',
             'url':'{{ url|escapejs }}',
             'topic': {{ topic_id }}
    };
    $.ajax({
		url: url,
        type: "POST",
        data: data,
        success: function(response) {
            $('#popup-body').html(response);
            $('#popup').modal('show');
	    },
        error: function(xhr, status) {
            bootbox.alert(xhr.responseText);
	    }
    });
}
function OpenSavePopup() {

    filters = "{{ filters }}";

    include_code_value = "false"
    include_code = '{{ include_code }}';
    if (include_code=='True') {
       include_code_value = "true"
    }

    range_value = "false"
    range = '{{ range }}';
    if (range=='True') {
       range_value = "true"
    }

    url = '/query_editor_save/';
    data = { 'title': '{{ title|escapejs }}',
             'description':'{{ description|escapejs }}',
             'sql':'{{ sql|escapejs }}',
             'table': '{{ table_name|escapejs }}',
             'columns': '{{ columns|escapejs }}',
             'rows': '{{ rows }}',
             'obs_values': '{{ selected_obs_values|escapejs }}',
             'aggregations': '{{ sel_aggregate|escapejs }}',
             'filters': '{{ filters|jsonify|escapejs }}',
             'agg_filters': '{{ agg_filters|jsonify|escapejs }}',
             'include_code': include_code_value,
             'range': range_value,
             'not_sel_aggregations': '{{ not_sel_aggregations|escapejs }}',
             'not_agg_selection_value': '{{ not_agg_selection_value|jsonify|escapejs }}'
              };
    $.ajax({
		url: url,
        type: "POST",
        data: data,
        success: function(response) {
            $('#popup-body').html(response);
            $('#popup').modal('show');
	    },
        error: function(xhr, status) {
			bootbox.alert(xhr.responseText);
	    }
    });
}
$("#morebtn").click(function() {
    $(this).html(($(this).html() == "{% trans "See more" %}")? "{% trans "See less" %}" : "{% trans "See more" %}");
    var el = document.getElementById("suspension_points");
    if (el.innerHTML == "...") {
        el.innerHTML = ",";
    }
    else {
        el.innerHTML = "...";
    }
});
$("#apply_button").click(function() {
    var progress$ = $("#progress");
    progress$.show();
    action = get_params(this, "");
    $(this).closest("form").attr('action', action);
});
$("#refresh_button").click(function() {
    var progress$ = $("#progress");
    progress$.show();
    action = get_params(this, "");
    $(this).closest("form").attr('action', action);
});
$("#refresh_button_save").click(function() {
    var progress$ = $("#progress");
    progress$.show();
    action = "?save=true"
    action = get_params(this, action);
    $(this).closest("form").attr('action', action);
});
$(".download_csv_button").click(function(e) {
    e.preventDefault();
    store = "{{ store }}";
    title = "{{ title.strip }}";
    params = "store=" + store + "&title=" +  title
    download('/download_csv',
             params,
             'POST',
             "{% csrf_token %}");
});
$(".download_xls_button").click(function(e) {
    e.preventDefault();
    store = "{{ store }}";
    title = "{{ title.strip }}";
    description = "{{ description.strip|escapejs }}";
    params = "store=" + store + "&title=" +  title
    if (description != "" ) {
        params = params + "&description=" + description;
    }
    download('/download_xls',
             params,
             'POST', "{% csrf_token %}");
});
$(".download_xlsx_button").click(function(e) {
    e.preventDefault();
    store = "{{ store }}";
    title = "{{ title.strip }}";
    description = "{{ description.strip|escapejs }}";
    params = "store=" + store + "&title=" +  title
    if (description != "" ) {
        params = params + "&description=" + description;
    }
    download('/download_xlsx',
             params,
             'POST', "{% csrf_token %}");
});
$(".download_sdmx_button").click(function(e) {
    e.preventDefault();
    store = "{{ store }}";
    title = "{{ title.strip }}";
    sql = "{{ sql|escapejs }}"
    params = "store=" + store + "&title=" +  title + "&sql=" + sql
    download('/download_sdmx',
             params,
             'POST', "{% csrf_token %}");
});
$(".download_json_stat_button").click(function(e) {
    e.preventDefault();
    store = "{{ store }}";
    title = "{{ title.strip }}";
    sql = "{{ sql|escapejs }}"
    params = "store=" + store + "&title=" +  title + "&sql=" + sql
    download('/download_json_stat',
             params,
             'POST', "{% csrf_token %}");
});
$(".download_rdf_button").click(function(e) {
   e.preventDefault();
   store = "{{ store }}";
   title = "{{ title.strip }}";
   sql = "{{ sql.strip|escapejs }}"
   description = "{{ description|escapejs }}"
   params = "store=" + store + "&title=" +  title + "&sql=" + sql +
           "&description=" + description
   download('/download_rdf',
            params,
            'POST', "{% csrf_token %}");
});
$(".download_turtle_button").click(function(e) {
   e.preventDefault();
   store = "{{ store }}";
   title = "{{ title.strip }}";
   sql = "{{ sql.strip|escapejs }}"
   description = "{{ description.strip|escapejs }}"
   params = "store=" + store + "&title=" +  title + "&sql=" + sql +
            "&description=" + description
   download('/download_turtle',
            params,
            'POST',
            "{% csrf_token %}");
});
</script>
{% endblock %}

